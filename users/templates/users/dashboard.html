<!-- users/templates/users/dashboard.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Личный кабинет</h2>
    <div class="msg">
    <p>ВНИМАНИЕ! Медицинским работникам для измениния их статуса необходимо
        обратиться к администратору сайта.</p>
    </div>
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3>Основная информация</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Имя пользователя:</strong> {{ user_profile.username }}</p>
                    <p><strong>ФИО:</strong> {{ user_profile.get_full_name|default:"Не указано" }}</p>
                    <p><strong>Email:</strong> {{ user_profile.email|default:"Не указан" }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Телефон:</strong> {{ user_profile.phone|default:"Не указан" }}</p>
                    <p><strong>Роль:</strong> {{ user_profile.get_role_display }}</p>
                    
                    {% if user_profile.role == 'patient' and user_profile.assigned_doctor %}
                        <p class="mt-3">
                            <strong>Ваш лечащий врач:</strong><br>
                            {{ user_profile.assigned_doctor }},
                            <span class="text-muted">{{ user_profile.assigned_doctor.specialization }}</span>
                        </p>
                    {% elif user_profile.role == 'patient' %}
                        <p class="mt-3 text-warning">
                            <strong>Лечащий врач не назначен</strong><br>
                            Выберите врача из списка доступных
                        </p>
                    {% endif %}
                    
                    {% if user_profile.role == 'doctor' %}
                        <p><strong>Специализация:</strong> {{ user_profile.specialization|default:"Не указана" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3>Действия</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% if user_profile.role == 'patient' %}
                <div class="col-md-4 mb-3">
                    {% if user_profile.assigned_doctor %}
                    <a href="{% url 'messaging:send_to' user_profile.assigned_doctor.id %}" 
                       class="btn btn-success w-100">
                        Написать врачу
                    </a>
                    {% else %}
                    <button class="btn btn-secondary w-100" disabled title="Сначала выберите врача">
                        Написать врачу
                    </button>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <a href="{% url 'users:assign_doctor' %}" class="btn btn-info w-100">
                        {% if user_profile.assigned_doctor %}Сменить врача{% else %}Выбрать врача{% endif %}
                    </a>
                </div>
                
                <div class="col-md-4 mb-3">
                    <a href="{% url 'anketa:start' %}" class="btn btn-info w-100">
                        Заполнить анкету
                    </a>
                </div>
                {% endif %}
                
                {% if user_profile.role == 'doctor' %}
                <div class="col-md-4 mb-3">
                    <a href="{% url 'users:patient_list' %}" class="btn btn-info w-100">
                        Мои пациенты
                    </a>
                </div>
                {% endif %}
                
                <div class="col-md-4 mb-3">
                    <a href="{% url 'users:profile_edit' %}" class="btn btn-warning w-100">
                        Редактировать профиль
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if user_profile.role == 'doctor' %}
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3>Статистика</h3>
        </div>
        <div class="card-body">
            <p>Количество пациентов: {{ user_profile.doctor_patients.count }}</p>
            <p>Новых сообщений: {{ unread_messages_count }}</p>
        </div>
    </div>
    {% endif %}
</div>
{% include "main/na1str.html" %}

<!-- Отладочная информация -->
<div class="debug-info" style="margin-top: 50px; padding: 20px; background: #f8f9fa; border: 1px solid #ddd; font-family: monospace;">
    <h4>Отладочная информация:</h4>

    <h5>1. Данные пользователя:</h5>
    <ul>
        <li>ID: {{ debug_info.user_data.id }}</li>
        <li>Username: {{ debug_info.user_data.username }}</li>
        <li>Role: {{ debug_info.user_data.role }}</li>
        <li>Doctor ID: {{ debug_info.user_data.assigned_doctor_id|default:"Не назначен" }}</li>
        <li>Active: {{ debug_info.user_data.is_active|yesno:"Да,Нет" }}</li>
    </ul>

    {% if debug_info.doctor_data %}
    <h5>2. Данные лечащего врача:</h5>
    <ul>
        <li>ID: {{ debug_info.doctor_data.id }}</li>
        <li>Username: {{ debug_info.doctor_data.username }}</li>
        <li>Specialization: {{ debug_info.doctor_data.specialization|default:"Не указана" }}</li>
    </ul>
    {% else %}
    <h5>2. Лечащий врач не назначен</h5>
    {% endif %}

    {% if user_profile.assigned_doctor %}
    <h5>3. Проверка связей:</h5>
    <ul>
        <li>user.assigned_doctor: {{ user_profile.assigned_doctor }}</li>
        <li>user.assigned_doctor.id: {{ user_profile.assigned_doctor.id }}</li>
        <li>user.assigned_doctor.specialization: {{ user_profile.assigned_doctor.specialization }}</li>
    </ul>
    {% endif %}
</div>


<style>
    .msg {
        background-color: white;
        color: #FF0000;
        margin-left: 10px;
    }
</style>


{% endblock %}